#!/bin/bash
# Purpose: To generate a report of malware infected files by performing a vulnerability scan and malware scan on a specified application.
# Author: Guman Singh | Cloudways
# Last Edited: 20/12/2023:14:49
# Usage: wget https://raw.githubusercontent.com/ThakurGumansingh/scripts/main/malware_scan.sh && bash malware_scan.sh

# Define colors
GREEN=$(tput setaf 2)
RESET=$(tput sgr0)

# Get the current working directory
current_dir=$(pwd)

# Extract the database name from the directory path
dbname=$(echo "$current_dir" | grep -oP '(?<=applications/)[^/]+')

# Download Wordfence CLI
wget https://github.com/wordfence/wordfence-cli/releases/download/v2.1.0rc9/wordfence_amd64.tar.gz

# Extract the downloaded tarball
tar xvzf wordfence_amd64.tar.gz

./wordfence --version && ./wordfence vuln-scan /home/master/applications/$dbname/public_html

./wordfence malware-scan --progress --no-cache --output-format csv --output-path /home/master/applications/$dbname/public_html/malware_report.csv /home/master/applications/$dbname/public_html

echo "${GREEN}\nMalware scan has been performed successfully, please check the malware_report"
cat malware_report.csv
# Clean up downloaded files
rm -rf wordfence wordfence_amd64.tar.gz
rm malware_scan.sh
cd && cd .config
rm -rf wordfence
exit
